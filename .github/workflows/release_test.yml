name: release pr title update

on:
  pull_request:
    branches:
      - 'release/*/base'
    types:
      - opened
      - reopened
      - auto_merge_enabled
      - auto_merge_disabled

permissions: write-all

env:
  BASE_BRANCH_NAME: ${{ github.event.pull_request.base.ref }}
  HEAD_BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
  LAYER_NAME: "release"
  HAED_LAYER_NAME: "deploy"

jobs:
  deploy-pr-title-update:
    runs-on: ubuntu-latest

    steps:
      - name: Check Head Branch
        id: check_head
        run: |
          # ë§ˆì§€ë§‰ '/'ë¡œë¶€í„° ì• ê¸€ì ì¶”ì¶œ ex) deploy/scrum/base -> 'deploy/scurm/' ì¶”ì¶œ
          BASE_NAME=$(echo $BASE_BRANCH_NAME | cut -d'/' -f2)

          # HEAD ë¸Œëœì¹˜ê°€ deploy ë¸Œëœì¹˜ ì¸ì§€ í™•ì¸
          if [[ $HEAD_BRANCH_NAME == deploy/* ]]; then
            echo "PRì˜ Head branchê°€ release childì´ê±°ë‚˜ deploy base ë¸Œëœì¹˜ ì´ë¯€ë¡œ ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
            echo "CHECK_FLAG=true" >> $GITHUB_OUTPUT
            HEAD_NAME=$(echo $HEAD_BRANCH_NAME | cut -d'/' -f2)
            echo "base_name=$BASE_NAME" >> $GITHUB_OUTPUT
            echo "child_name=$HAED_LAYER_NAME/$HEAD_NAME" >> $GITHUB_OUTPUT
          # HEAD ë¸Œëœì¹˜ê°€ BASE ë¸Œëœì¹˜ì™€ ë™ì¼í•œ ìŠ¤í¬ëŸ¼ëª…ì„ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸
          elif [[ $HEAD_BRANCH_NAME == release/* ]]; then
            echo "ë™ì¼ ë°°í¬ ëª…ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
            echo "$BASE_NAME $HEAD_NAME"
            echo "CHECK_FLAG=true" >> $GITHUB_OUTPUT
            HEAD_NAME=$(echo $HEAD_BRANCH_NAME | cut -d'/' -f3)
            echo "base_name=$BASE_NAME" >> $GITHUB_OUTPUT
            echo "child_name=$HEAD_NAME" >> $GITHUB_OUTPUT
          else
            echo "PRì˜ Head branch ì„¤ì •ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. [HEAD BRANCH: '$HEAD_BRANCH_NAME']"
            echo "CHECK_FLAG=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Check PR Title
        id: pr_title
        run: |
          PR_TITLE=$(curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" | jq -r .title)

          # PR ì œëª©ì´ $LAYER_NAME ì‹œì‘í•˜ë©´ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤.
          if [[ "$PR_TITLE" == "$LAYER_NAME"* ]]; then
            echo "PR ì œëª©ì´ '$LAYER_NAME'ë¡œ ì‹œì‘í•˜ë¯€ë¡œ ì´ë¦„ì„ ë¶™ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          else
            echo "PR ì œëª©ì´ '$LAYER_NAME'ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë‹¤ìŒ ì•ì— layer ì´ë¦„ì„ ì¶”ê°€í•©ë‹ˆë‹¤."
            NEW_TITLE="$LAYER_NAME/${{ steps.check_head.outputs.base_name }} <- ${{ steps.check_head.outputs.child_name }} $PR_TITLE"
            echo "pr_title=$NEW_TITLE" >> $GITHUB_OUTPUT
          fi

      - name: Set Random Emoji
        id: random_emoji
        if: ${{ steps.pr_title.outputs.pr_title != '' && steps.check_head.outputs.CHECK_FLAG == 'true' }}
        run: |
          # ëœë¤ ì´ëª¨ì§€ ìƒì„±
          emojis=("ğŸ”¥" "ğŸš¨" "â˜„ï¸" "â¤ï¸â€ğŸ”¥" "ğŸï¸" "ğŸ¥Š" "ğŸŒ¹" "ğŸš’")
          random_index=$((RANDOM % ${#emojis[@]}))
          random_emoji="${emojis[$random_index]}"
          echo "random_auto=(Auto${random_emoji})" >> $GITHUB_OUTPUT

      - name: Check Auto merge
        id: convert_title
        if: ${{ steps.pr_title.outputs.pr_title != '' && steps.check_head.outputs.CHECK_FLAG == 'true' }}
        run: |
          PR_TITLE="${{ steps.pr_title.outputs.pr_title }}"

          # ê°’ì´ ìˆìœ¼ë©´ == trueë©´ "Object", ì—†ìœ¼ë©´ == falseë©´ ""
          PR_STATE="${{ github.event.pull_request.auto_merge }}"
          echo "í˜„ì¬ PR ìƒíƒœ: $PR_STATE"

          # Check if "(Auto)" is present in the PR title
          if [[ $PR_TITLE == *"(Auto"* ]]; then
            AUTO_PRESENT=true
          else
            AUTO_PRESENT=false
          fi

          echo "ì˜¤í†  í¬í•¨ ì—¬ë¶€: $AUTO_PRESENT"

          # Determine the new title based on the PR state
          if [[ "$PR_STATE" == "Object" && "$AUTO_PRESENT" == "false" ]]; then
            NEW_TITLE="$PR_TITLE ${{ steps.random_emoji.outputs.random_auto }}"
            echo "ì˜¤í† ë¨¸ì§€ ì¼¬ ì¶”ì¶œëœ ì´ë¦„: $NEW_TITLE"
            echo "convert_title=$NEW_TITLE" >> $GITHUB_OUTPUT
          elif [[ "$PR_STATE" != "Object" && "$AUTO_PRESENT" == "true" ]]; then
            NEW_TITLE=$(echo $PR_TITLE | sed 's/(Auto.*$//')
            echo "ì˜¤í† ë¨¸ì§€ ë” ì¶”ì¶œëœ ì´ë¦„: $NEW_TITLE"
            echo "convert_title=$NEW_TITLE" >> $GITHUB_OUTPUT
          else
            echo "ì¼ë°˜ ìƒíƒœ ì¶”ì¶œëœ ì´ë¦„: $PR_TITLE"
            echo "convert_title=$PR_TITLE" >> $GITHUB_OUTPUT
          fi

      - name: Update PR Title
        if: ${{ steps.convert_title.outputs.convert_title != '' && steps.check_head.outputs.CHECK_FLAG == 'true' }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"  # ì—…ë°ì´íŠ¸í•  PR ë²ˆí˜¸
          NEW_TITLE="${{ steps.convert_title.outputs.convert_title }}"

          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ PR ì œëª© ì—…ë°ì´íŠ¸
          curl -X PATCH \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -d "{\"title\":\"$NEW_TITLE\"}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER"
